<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Capture</title>

    <meta
      name="viewport"
      content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"
    />
    <style type="text/css">
      #start-camera {
        margin-top: 50px;
      }

      #prompt {
        display: block;
        margin: 20px auto 0 auto;
      }

      button {
        width: 120px;
        padding: 5px;
        display: block;
        margin: 10px auto;
        border: 2px solid #111111;
        cursor: pointer;
        background-color: white;
      }

      .row {
        display: flex;
      }

      .column {
        flex: 25%;
        padding: 5px;
      }

      #video,
      #canvas,
      #capture,
      #grey-canvas,
      #small-canvas {
        display: block;
        margin: 0 auto 20px auto;
      }
    </style>
  </head>

  <body>
    <img src="prompt-images/sf-0-do.png" width="320" height="240" id="prompt" />

    <button id="change">Change</button>
    <button id="start-camera">Start Camera</button>
    <button id="stop-camera" style="display: none">Stop Camera</button>

    <div class="row">
      <div class="column">
        <video id="video" width="320" height="240" autoplay=""></video>
        <button id="capture" style="display: none;">Capture</button>
      </div>

      <div class="column">
        <canvas id="canvas" width="320" height="240"></canvas>
        <button id="save" style="display: none;">Save</button>
      </div>

      <div class="column">
        <canvas id="grey-canvas" width="320" height="240"></canvas>
        <button id="save-grey" style="display: none;">Save</button>
      </div>

      <div class="column">
        <canvas id="small-canvas" width="28" height="28"></canvas>
        <button id="save-small" style="display: none;">Save</button>
      </div>
    </div>

    <canvas
      id="hidden-canvas"
      width="320"
      height="240"
      style="display: none"
    ></canvas>
    <a id="image-anchor" style="display: none" />

    <script>
      let prompts = new Array(
        'prompt-images/sf-0-do.png',
        'prompt-images/sf-1-re.png',
        'prompt-images/sf-2-mi.png',
        'prompt-images/sf-3-fa.png',
        'prompt-images/sf-4-sol.png',
        'prompt-images/sf-5-la.png',
        'prompt-images/sf-6-ti.png'
      )

      let tones = new Array(
        261.63,
        293.66,
        329.63,
        349.23,
        392.0,
        440.0,
        493.88
      )

      let video = document.querySelector('#video')
      let canvas = document.querySelector('#canvas')
      let grey_canvas = document.querySelector('#grey-canvas')
      let small_canvas = document.querySelector('#small-canvas')
      let hidden_canvas = document.querySelector('#hidden-canvas')

      let camera_button = document.querySelector('#start-camera')
      let stop_camera_button = document.querySelector('#stop-camera')
      let change_button = document.querySelector('#change')
      let capture_button = document.querySelector('#capture')
      let save_button = document.querySelector('#save')
      let save_grey_button = document.querySelector('#save-grey')
      let save_small_button = document.querySelector('#save-small')

      let stream = null
      var r = null
      var a_image = null

      choosePrompt()

      function choosePrompt () {
        r = Math.floor(Math.random() * prompts.length)
        document.getElementById('prompt').src = prompts[r]
        play_tone()
      }

      change_button.addEventListener('click', function () {
        choosePrompt()
      })

      camera_button.addEventListener('click', async function () {
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: false
          })
        } catch (error) {
          alert(error.message)
          return
        }

        video.srcObject = stream
        video.style.display = 'block'
        camera_button.style.display = 'none'
        capture_button.style.display = 'block'
        stop_camera_button.style.display = 'block'
      })

      stop_camera_button.addEventListener('click', function () {
        video.pause()
        video.src = ''
        window.localStream = stream

        // camera light stays on - no obvious solution
        var tracks = stream.getTracks()
        tracks.forEach(track => (track.enabled = false))

        camera_button.style.display = 'block'
        stop_camera_button.style.display = 'none'
      })

      capture_button.addEventListener('click', function () {
        canvas
          .getContext('2d')
          .drawImage(video, 0, 0, canvas.width, canvas.height)

        let filename =
          'sf-' +
          r +
          '_' +
          Math.random()
            .toString(36)
            .slice(2, 10) +
          '.png'

        let blob = document.querySelector('#canvas').toBlob(function (blob) {
          a_image = document.querySelector('#image-anchor')
          a_image.href = URL.createObjectURL(blob)
          a_image.download = filename
        }, 'image/png')

        save_button.style.display = 'block'
        save_small_button.style.display = 'block'
        makeGrey()
      })

      function makeGrey () {
        let color_context = canvas.getContext('2d')
        let grey_context = grey_canvas.getContext('2d')
        let small_context = small_canvas.getContext('2d')
        let hidden_context = hidden_canvas.getContext('2d')

        grey_context.drawImage(canvas, 0, 0, canvas.width, canvas.height)

        let imgData = color_context.getImageData(
          0,
          0,
          canvas.width,
          canvas.height
        )

        let pixels = imgData.data

        let min_lightness = 128
        let max_lightness = 128

        // make grey
        for (var i = 0; i < pixels.length; i += 4) {
          // other ratios are available
          let lightness = parseInt(
            (pixels[i] + pixels[i + 1] + pixels[i + 2]) / 3
          )
          pixels[i] = lightness
          pixels[i + 1] = lightness
          pixels[i + 2] = lightness
          if (lightness < min_lightness) min_lightness = lightness
          if (lightness > max_lightness) max_lightness = lightness
        }

        // scale lightness to 0...255
        for (var i = 0; i < pixels.length; i += 4) {
          let lightness = parseInt(
            (pixels[i] + pixels[i + 1] + pixels[i + 2]) / 3
          )
          lightness =
            ((lightness - min_lightness) * 255) /
            (max_lightness - min_lightness)
          pixels[i] = lightness
          pixels[i + 1] = lightness
          pixels[i + 2] = lightness
        }
        grey_context.putImageData(imgData, 0, 0)

        // scale size via a temp canvas
        hidden_context.putImageData(imgData, 0, 0)

        small_context.scale(28 / 320, 28 / 240)
        small_context.drawImage(hidden_canvas, 0, 0)

        save_grey_button.style.display = 'block'
        save_small_button.style.display = 'block'
      }

      save_button.addEventListener('click', function () {
        a_image.click()
        choosePrompt()
      })

      function play_tone () {
        var context = new AudioContext()
        var oscillator = context.createOscillator()
        oscillator.type = 'sine'
        oscillator.frequency.value = tones[r]
        oscillator.connect(context.destination)
        oscillator.start()

        setTimeout(function () {
          oscillator.stop()
        }, 500)
      }
    </script>
  </body>
</html>
